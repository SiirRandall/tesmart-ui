name: Release (Fyne + SLSA)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name to publish (e.g., v0.4.0). Required when running manually if not on a tag."
        required: false
        type: string
      prerelease:
        description: "Mark release as prerelease?"
        required: false
        type: boolean
        default: false
  release:
    types: [created]

permissions:
  contents: write
  id-token: write

env:
  APP_ID: com.siirrandall.tesmartui
  APP_NAME: TeSmart UI
  ICON_PATH: ./internal/ui/assets/tray.png
  SRC_DIR: ./cmd/tesmart-ui

jobs:
  build-linux-amd64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install GL/X11 dev headers for Fyne
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc pkg-config libgl1-mesa-dev xorg-dev libxkbcommon-dev

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'

      - name: Build (linux/amd64)
        env:
          CGO_ENABLED: '1'
        run: |
          mkdir -p dist
          cd "$SRC_DIR"
          GOOS=linux GOARCH=amd64 go build -trimpath -o ../../dist/tesmart-ui-linux-amd64
          cd ../../dist
          chmod +x tesmart-ui-linux-amd64
          tar -czf tesmart-ui-linux-amd64.tar.gz tesmart-ui-linux-amd64

      - name: Upload linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: dist/tesmart-ui-linux-amd64.tar.gz

  build-macos-amd64:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'

      - name: Install fyne CLI
        run: |
          go install fyne.io/fyne/v2/cmd/fyne@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Package app (darwin/amd64) with icon
        env:
          CGO_ENABLED: '1'
          APP_NAME: ${{ env.APP_NAME }}
          APP_ID:   ${{ env.APP_ID }}
          SRC_DIR:  ${{ env.SRC_DIR }}
          ICON_PATH: ${{ env.ICON_PATH }}
        run: |
          mkdir -p dist
          # Build & package with fyne (uses your PNG; generates .icns automatically)
          fyne package -os darwin \
            -name "${APP_NAME}" \
            -appID "${APP_ID}" \
            -icon "${ICON_PATH}" \
            -release \
            -sourceDir "${SRC_DIR}"

          # The output is "<APP_NAME>.app" in the working dir
          # (Optional) ad-hoc sign to avoid odd “damaged” cases
          codesign --force --deep --sign - "${APP_NAME}.app"

          # Zip preserving bundle metadata; keep quarantine so users see Open Anyway
          ditto -c -k --sequesterRsrc --keepParent "${APP_NAME}.app" "tesmart-ui-macos-amd64.zip"
          mv "tesmart-ui-macos-amd64.zip" dist/

      - name: Upload macOS amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-amd64
          path: dist/tesmart-ui-macos-amd64.zip

  build-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'

      - name: Install fyne CLI
        run: |
          go install fyne.io/fyne/v2/cmd/fyne@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

      - name: Package app (darwin/arm64) with icon
        env:
          CGO_ENABLED: '1'
          APP_NAME: ${{ env.APP_NAME }}
          APP_ID:   ${{ env.APP_ID }}
          SRC_DIR:  ${{ env.SRC_DIR }}
          ICON_PATH: ${{ env.ICON_PATH }}
        run: |
          mkdir -p dist
          # Force arm64 build via GOARCH when packaging
          GOOS=darwin GOARCH=arm64 fyne package \
            -os darwin \
            -name "${APP_NAME}" \
            -appID "${APP_ID}" \
            -icon "${ICON_PATH}" \
            -release \
            -sourceDir "${SRC_DIR}"

          # (Optional) ad-hoc sign
          codesign --force --deep --sign - "${APP_NAME}.app"

          ditto -c -k --sequesterRsrc --keepParent "${APP_NAME}.app" "tesmart-ui-macos-arm64.zip"
          mv "tesmart-ui-macos-arm64.zip" dist/

      - name: Upload macOS arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: dist/tesmart-ui-macos-arm64.zip

  build-windows-amd64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install MSYS2 MinGW
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkg-config

      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'

      - name: Build (windows/amd64)
        shell: bash
        env:
          CGO_ENABLED: '1'
          CC: x86_64-w64-mingw32-gcc
          CXX: x86_64-w64-mingw32-g++
        run: |
          mkdir -p dist
          cd "$SRC_DIR"
          GOOS=windows GOARCH=amd64 go build -trimpath -ldflags "-H=windowsgui -s -w" -o ../../dist/tesmart-ui-windows-amd64.exe
          cd ../../dist
          powershell -Command "Compress-Archive -Path tesmart-ui-windows-amd64.exe -DestinationPath tesmart-ui-windows-amd64.zip"

      - name: Upload windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: dist/tesmart-ui-windows-amd64.zip

  publish:
    needs:
      - build-linux-amd64
      - build-macos-amd64
      - build-macos-arm64
      - build-windows-amd64
    runs-on: ubuntu-22.04
    env:
      TAG: ${{ github.ref_type == 'tag' && github.ref_name || inputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Fail if no tag was provided on manual run
        if: ${{ github.ref_type != 'tag' && (inputs.tag == '' || inputs.tag == null) }}
        run: |
          echo "This workflow requires a tag. Provide one via 'Run workflow' → tag (e.g., v0.4.0), or push a tag and run on that."
          exit 1
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Restore exec bits
        run: chmod +x dist/tesmart-ui-linux-amd64 || true
      - name: List artifacts (debug)
        run: ls -l dist
      - name: Upload assets to the Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          generate_release_notes: true
          make_latest: true
          prerelease: ${{ inputs.prerelease == true }}
          files: |
            dist/tesmart-ui-linux-amd64.tar.gz
            dist/tesmart-ui-macos-amd64.zip
            dist/tesmart-ui-macos-arm64.zip
            dist/tesmart-ui-windows-amd64.zip