name: Release (Fyne + SLSA)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag name to publish (e.g., v0.4.0). Required when running manually if not on a tag."
        required: false
        type: string
      prerelease:
        description: "Mark release as prerelease?"
        required: false
        type: boolean
        default: false
  release:
    types: [created]

permissions:
  contents: write
  id-token: write

env:
  APP_ID: com.siirrandall.tesmartui
  APP_NAME: TeSmart UI
  ICON_PATH: ./internal/ui/assets/tray.png
  SRC_DIR: ./cmd/tesmart-ui

jobs:
  build-linux-amd64:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install GL/X11 dev headers for Fyne
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc build-essential pkg-config \
            libgl1-mesa-dev xorg-dev libxkbcommon-dev \
            libxrandr-dev libxxf86vm-dev libxi-dev libxcursor-dev libxinerama-dev
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'
      - name: Build (linux/amd64)
        env:
          CGO_ENABLED: '1'
        run: |
          mkdir -p dist
          cd "$SRC_DIR"
          GOOS=linux GOARCH=amd64 go build -trimpath -o ../../dist/tesmart-ui-linux-amd64
          cd ../../dist
          chmod +x tesmart-ui-linux-amd64
          tar -czf tesmart-ui-linux-amd64.tar.gz tesmart-ui-linux-amd64
      - name: Upload linux binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-amd64
          path: dist/tesmart-ui-linux-amd64.tar.gz

  package-linux-appimage:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'
      - name: Install build deps (GL/X11 + toolchain + fuse)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential gcc pkg-config \
            libgl1-mesa-dev xorg-dev \
            libxrandr-dev libxxf86vm-dev libxi-dev libxcursor-dev libxinerama-dev \
            libfuse2
      - name: Install Fyne CLI
        run: |
          go install fyne.io/tools/cmd/fyne@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH
          which fyne
          fyne version || true
      - name: Package Linux bundle with Fyne
        env:
          CGO_ENABLED: '1'
          APP_NAME: ${{ env.APP_NAME }}
          APP_ID:   ${{ env.APP_ID }}
          SRC_DIR:  ${{ env.SRC_DIR }}
        run: |
          set -euo pipefail
          ICON_ABS="$(pwd)/internal/ui/assets/tray.png"
          fyne package \
            --os linux \
            --name "${APP_NAME}" \
            --app-id "${APP_ID}" \
            --icon "${ICON_ABS}" \
            --release \
            --source-dir "${SRC_DIR}"
      - name: Build AppImage from AppDir
        env:
          APP_NAME: ${{ env.APP_NAME }}
        run: |
          set -euo pipefail

          APPDIR="AppDir"
          BIN_NAME="tesmart-ui"
          ICON_ABS="$(pwd)/internal/ui/assets/tray.png"

          # 1) Extract Fyne bundle (debug)
          rm -rf appdir "${APPDIR}"
          mkdir -p appdir "${APPDIR}"
          echo "== Contents of ${APP_NAME}.tar.xz =="
          tar -tJf "${APP_NAME}.tar.xz" || true
          tar -xJf "${APP_NAME}.tar.xz" -C appdir
          echo "== After extract =="
          ls -la appdir || true

          # 2) If we have an install-style usr/ tree, copy it into AppDir/usr
          if [ -d "appdir/usr" ]; then
            mkdir -p "${APPDIR}/usr"
            cp -a appdir/usr/. "${APPDIR}/usr/"
          else
            echo "ERROR: Expected 'usr/' tree in Fyne tarball but none found."
            ls -la appdir
            exit 1
          fi

          # 3) Locate the binary anywhere under AppDir/usr and normalize to AppDir/usr/bin/tesmart-ui
          mkdir -p "${APPDIR}/usr/bin"
          FOUND_BIN="$(find "${APPDIR}/usr" -type f -perm -u+x -name "${BIN_NAME}" | head -n1 || true)"
          if [ -z "${FOUND_BIN}" ]; then
            # Fall back to any executable under a bin directory
            FOUND_BIN="$(find "${APPDIR}/usr" -type f -perm -u+x -path '*/bin/*' | head -n1 || true)"
          fi
          if [ -z "${FOUND_BIN}" ] || [ ! -f "${FOUND_BIN}" ]; then
            echo "ERROR: No executable found under ${APPDIR}/usr"
            find "${APPDIR}" -maxdepth 4 -type f -printf "%M %p\n" || true
            exit 1
          fi
          # Move/rename to our canonical location
          mv "${FOUND_BIN}" "${APPDIR}/usr/bin/${BIN_NAME}"
          chmod +x "${APPDIR}/usr/bin/${BIN_NAME}"

          # 4) Desktop file & icon
          # Prefer the ones packaged by Fyne under usr/local/share/...
          DESKTOP_SRC="$(find appdir/usr/local/share/applications -maxdepth 1 -type f -name '*.desktop' 2>/dev/null | head -n1 || true)"
          ICON_SRC="$(find appdir/usr/local/share/pixmaps -maxdepth 1 -type f \( -name '*.png' -o -name '*.svg' \) 2>/dev/null | head -n1 || true)"

          if [ -n "${DESKTOP_SRC}" ]; then
            cp "${DESKTOP_SRC}" "${APPDIR}/${APP_NAME}.desktop"
          else
            # Synthesize a basic .desktop if missing
            cat > "${APPDIR}/${APP_NAME}.desktop" <<EOF
          [Desktop Entry]
          Type=Application
          Name=${APP_NAME}
          Exec=${BIN_NAME}
          Icon=${APP_NAME}
          Terminal=false
          Categories=Utility;
          EOF
          fi

          # Icon: prefer packaged one; else repo icon; else warn
          if [ -n "${ICON_SRC}" ]; then
            cp "${ICON_SRC}" "${APPDIR}/${APP_NAME}.png"
          elif [ -f "${ICON_ABS}" ]; then
            cp "${ICON_ABS}" "${APPDIR}/${APP_NAME}.png"
          else
            echo "WARNING: No icon found; proceeding without a custom icon."
          fi

          # Normalize Exec and Icon entries
          sed -i "s|^Exec=.*|Exec=${BIN_NAME}|" "${APPDIR}/${APP_NAME}.desktop"
          sed -i "s|^Icon=.*|Icon=${APP_NAME}|" "${APPDIR}/${APP_NAME}.desktop"

          # 5) Minimal AppRun launcher
          cat > "${APPDIR}/AppRun" << 'EOF'
          #!/usr/bin/env sh
          HERE="$(dirname "$(readlink -f "$0")")"
          export PATH="$HERE/usr/bin:$PATH"
          exec "$HERE/usr/bin/tesmart-ui" "$@"
          EOF
          chmod +x "${APPDIR}/AppRun"

          # 6) Build AppImage
          wget -q https://github.com/AppImage/AppImageKit/releases/download/13/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          ./appimagetool --comp zstd "${APPDIR}" "${APP_NAME}.AppImage"

          mkdir -p dist
          chmod +x "${APP_NAME}.AppImage"
          mv "${APP_NAME}.AppImage" dist/tesmart-ui-linux.AppImage

  build-macos-amd64:
    runs-on: macos-13
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'
      - name: Install fyne CLI (new toolchain)
        run: |
          go install fyne.io/tools/cmd/fyne@latest
          sudo rm -f /usr/local/bin/fyne || true
          sudo ln -sf "$HOME/go/bin/fyne" /usr/local/bin/fyne
          echo "$HOME/go/bin" >> $GITHUB_PATH
          which fyne
          fyne version || true
      - name: Package app (darwin/amd64) with icon
        env:
          CGO_ENABLED: '1'
          APP_NAME: ${{ env.APP_NAME }}
          APP_ID:   ${{ env.APP_ID }}
          SRC_DIR:  ${{ env.SRC_DIR }}
        run: |
          set -euo pipefail
          mkdir -p dist
          ICON_ABS="$(pwd)/internal/ui/assets/tray.png"
          fyne package \
            --os darwin \
            --name "${APP_NAME}" \
            --app-id "${APP_ID}" \
            --icon "${ICON_ABS}" \
            --release \
            --source-dir "${SRC_DIR}"
          codesign --force --deep --sign - "${APP_NAME}.app"
          ARCH=amd64
          ditto -c -k --sequesterRsrc --keepParent "${APP_NAME}.app" "tesmart-ui-macos-${ARCH}.zip"
          mv "tesmart-ui-macos-${ARCH}.zip" dist/
      - name: Upload macOS amd64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-amd64
          path: dist/tesmart-ui-macos-amd64.zip

  build-macos-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'
      - name: Install fyne CLI (new toolchain)
        run: |
          go install fyne.io/tools/cmd/fyne@latest
          sudo rm -f /usr/local/bin/fyne || true
          sudo ln -sf "$HOME/go/bin/fyne" /usr/local/bin/fyne
          echo "$HOME/go/bin" >> $GITHUB_PATH
          which fyne
          fyne version || true
      - name: Package app (darwin/arm64) with icon
        env:
          CGO_ENABLED: '1'
          APP_NAME: ${{ env.APP_NAME }}
          APP_ID:   ${{ env.APP_ID }}
          SRC_DIR:  ${{ env.SRC_DIR }}
        run: |
          set -euo pipefail
          mkdir -p dist
          ICON_ABS="$(pwd)/internal/ui/assets/tray.png"
          GOOS=darwin GOARCH=arm64 fyne package \
            --os darwin \
            --name "${APP_NAME}" \
            --app-id "${APP_ID}" \
            --icon "${ICON_ABS}" \
            --release \
            --source-dir "${SRC_DIR}"
          codesign --force --deep --sign - "${APP_NAME}.app"
          ARCH=arm64
          ditto -c -k --sequesterRsrc --keepParent "${APP_NAME}.app" "tesmart-ui-macos-${ARCH}.zip"
          mv "tesmart-ui-macos-${ARCH}.zip" dist/
      - name: Upload macOS arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: dist/tesmart-ui-macos-arm64.zip

  build-windows-amd64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install MSYS2 MinGW
        uses: msys2/setup-msys2@v2
        with:
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-pkg-config
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22.12'
      - name: Build (windows/amd64)
        shell: bash
        env:
          CGO_ENABLED: '1'
          CC: x86_64-w64-mingw32-gcc
          CXX: x86_64-w64-mingw32-g++
        run: |
          mkdir -p dist
          cd "$SRC_DIR"
          GOOS=windows GOARCH=amd64 go build -trimpath -ldflags "-H=windowsgui -s -w" -o ../../dist/tesmart-ui-windows-amd64.exe
          cd ../../dist
          powershell -Command "Compress-Archive -Path tesmart-ui-windows-amd64.exe -DestinationPath tesmart-ui-windows-amd64.zip"
      - name: Upload windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-amd64
          path: dist/tesmart-ui-windows-amd64.zip

  publish:
    needs:
      - build-linux-amd64
      - package-linux-appimage
      - build-macos-amd64
      - build-macos-arm64
      - build-windows-amd64
    runs-on: ubuntu-22.04
    env:
      TAG: ${{ github.ref_type == 'tag' && github.ref_name || inputs.tag }}
    steps:
      - uses: actions/checkout@v4
      - name: Fail if no tag was provided on manual run
        if: ${{ github.ref_type != 'tag' && (inputs.tag == '' || inputs.tag == null) }}
        run: |
          echo "This workflow requires a tag. Provide one via 'Run workflow' â†’ tag (e.g., v0.4.0), or push a tag and run on that."
          exit 1
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true
      - name: Restore exec bits
        run: |
          chmod +x dist/tesmart-ui-linux-amd64 || true
          chmod +x dist/tesmart-ui-linux.AppImage || true
      - name: List artifacts (debug)
        run: ls -l dist
      - name: Upload assets to the Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          generate_release_notes: true
          make_latest: true
          prerelease: ${{ inputs.prerelease == true }}
          files: |
            dist/tesmart-ui-linux-amd64.tar.gz
            dist/tesmart-ui-linux.AppImage
            dist/tesmart-ui-macos-amd64.zip
            dist/tesmart-ui-macos-arm64.zip
            dist/tesmart-ui-windows-amd64.zip